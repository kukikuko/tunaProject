<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="UTF-8" />

<title>Insert title here</title>
<!-- CSS only -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi"
	crossorigin="anonymous" />
<link rel="stylesheet" href="/css/posts.css" />
<link rel="stylesheet" href="/css/header.css" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">

<style>
.logoImg {
	width: 40px;
	height: 40px;
}
</style>
</head>
<body>
	<div th:replace="layout/header :: headFrag"></div>
	<div class="Post" name="post" id="post" th:value="${post.postCode}">
		<p class="post-code" id="postCode" th:text="${post.postCode}"></p>
		<p class="post-member" id="pMemCode" th:text="${post.pMemCode}"></p>

		<p class="post-category" th:text="${post.ctName}"></p>
		<p class="post-title" th:text="${post.pTitle}"></p>
		<p class="post-price">
			가격 : <span th:text="${post.pPrice}"></span>
		</p>
		<p class="post-time" th:if="${post.pCorrectionTime == null}"
			th:text="${#dates.format(post.pCreateTime, 'yy-MM-dd a hh시mm분')}"></p>
		<p class="post-time" th:if="${post.pCorrectionTime != null}"
			th:text="${#dates.format(post.pCorrectionTime, 'yy-MM-dd a hh시mm분')}"></p>
		<p class="post-view">
			조회수 : <span th:text="${post.pView}"></span>
		</p>
		<p class="post-content" th:text="${post.pContent}"></p>
		<img class="post-img" th:each="image : ${images}"
			th:src="|/posts/images/${image.imageFiles}|" width="300" height="300" /><br />
		<button th:if="${post.pMemCode} == ${member.memberCode}"
			th:onClick="|location.href='@{/posts/update/{postCode}(postCode=${post.postCode})}'|"
			class="post_Btn">수정</button>




		<form action="/posts/delete" method="post" class="deleteForm"
			name="deleteForm" id="deleteForm">
			<input type="hidden" th:value="${post.postCode}" name="postCode" />
			<button type="button"
				th:if="${post.pMemCode} == ${member.memberCode}" class="post_Btn"
				id="deleteBtn">삭제</button>
		</form>



		<button th:onclick="|location.href='@{/posts}'|" class="post_Btn_back">
			목록보기</button>

		<button th:if="${post.pMemCode} != ${member.memberCode}" type="button"
			id="notifyBtn">신고하기</button>

		<!-- 			class 건들면 찜하기 작동 안함 ㅅㄱ -->
		<th:block th:if="${cnt123 == 0}">
			<button th:if="${post.pMemCode} != ${member.memberCode}"
				class="heartBtn" type="submit" id="heartBtnWhite">찜하기</button>
		</th:block>

		<th:block th:if="${cnt123 >= 1}">
			<button th:if="${post.pMemCode} != ${member.memberCode}"
				class="heartBtn" type="submit" id="heartBtnRed">찜하기</button>
		</th:block>
	</div>
	<!-- JavaScript Bundle with Popper -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
		crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
	<script src="https://kit.fontawesome.com/ef08a6d352.js"
		crossorigin="anonymous"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
	<script>
      $("#postCode").css("display", "none");
      $("#pMemCode").css("display", "none");
      $("#heartBtnRed").css("backgroundColor", "red");
      if(document.getElementById("notifyBtn")){
	      document.getElementById("notifyBtn").addEventListener("click", (e) => {
	        Swal.fire({
	          title: "게시물을 신고하시겠습니까?",
	          text: "허위 신고시에, 관리자의 제재를 받을 수 있습니다.",
	          icon: "warning",
	          showCancelButton: true,
	          confirmButtonColor: "#3085d6",
	          cancelButtonColor: "#d33",
	          confirmButtonText: "승인",
	          cancelButtonText: "취소",
	          reverseButtons: true,
	        }).then((result) => {
	          if (result.isConfirmed) {
	            $.ajax({
	              type: "POST",
	              url: "/notify/post",
	              data: {
	                postCode: $("#postCode").text(),
	                pMemCode: $("#pMemCode").text(),
	              },
	              success: function (cnt) {
	                console.log(cnt);
	                if (cnt == 0) {
	                  //cnt가 0일때. 사용자가 신고하지 않은 게시글
	                  console.log(cnt);
	                  Swal.fire({
	                    icon: "success",
	                    title: "신고가 완료되었습니다.",
	                    text: "해당 게시물은 관리자에게 전달되었습니다.",
	                  }).then((result) => {
	                    location.href = "http://localhost:8080";
	                  });
	                } else if (cnt >= 1) {
	                  //cnt가 1 이상일때, 사용자가 1번 이상 신고한 게시글
	                  console.log(cnt);
	                  Swal.fire({
	                    icon: "error",
	                    title: "이미 신고된 게시물입니다.",
	                    text: "다시 한 번 확인해주세요.",
	                  });
	                }
	              },
	            });
	          }
	        });
	      });
	      }
      
      
      if(document.getElementById('deleteBtn')){
    		document.getElementById('deleteBtn').addEventListener('click', (e)=>{ 
    			e.preventDefault();
    			
    			let form = document.deleteForm;
    			
    	        Swal.fire({
    	            title: "게시글을 삭제하시겠습니까?",
    	            text: "삭제된 게시글은 되돌릴 수 없습니다.",
    	            icon: "warning",
    	            showCancelButton: true,
    	            confirmButtonColor: "#3085d6",
    	            cancelButtonColor: "#d33",
    	            confirmButtonText: "승인",
    	            cancelButtonText: "취소",
    	            reverseButtons: true,
    	          }).then((result) => {
    	        	  if(result.isConfirmed) {
    			            Swal.fire({
    			              title: "삭제가 완료되었습니다!", // Alert 제목
    			              text: "다른 물품등록으로, 거래를 이어가보세요!", // Alert 내용
    			              icon: "success", // Alert 타입
    			            }).then((result) => {
    			              	form.submit();	
    			            });
    	        	  }
    	          });
    			
    		});
    		}
      
      const Toast = Swal.mixin({
          toast: true,
          position: "center-center",
          showConfirmButton: false,
          timer: 2000,
          timerProgressBar: true,
          didOpen: (toast) => {
            toast.addEventListener("mouseenter", Swal.stopTimer);
            toast.addEventListener("mouseleave", Swal.resumeTimer);
          },
        });
      
      
      
      var heartBtn = document.querySelectorAll(".heartBtn");
	if(heartBtn){
      for (let i = 0; i < 2; i++) {
        heartBtn[i].addEventListener("click", (e) => {
          $.ajax({
            type: "POST",
            url: "/heart",
            data: {
              postCode: $("#postCode").text(),
            },
            success: function (cnt) {
              console.log(cnt);
              if ((cnt) => 1) {
                $("#heartBtnWhite").css("backgroundColor", "red");
                $("#heartBtnRed").css("backgroundColor", "red");
                Toast.fire({
                  icon: "success",
                  title: "찜 성공",
                });
              }
              if (cnt == 0) {
                $("#heartBtnWhite").css("backgroundColor", "#F0F0F0");
                $("#heartBtnRed").css("backgroundColor", "#F0F0F0");
                Toast.fire({
                  icon: "success",
                  title: "찜 취소",
                });
              }
            },
          });
        });
      }
	}		

	
    </script>
</body>
</html>
