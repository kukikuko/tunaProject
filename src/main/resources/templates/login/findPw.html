<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<title>Insert title here</title>
</head>
<body>
	<h1>비밀번호찾기</h1>
	
	<p>회원가입시 등록한 이메일을 입력해주세요.</p>
	<form action="" method="post">
	<div>
		<label>이메일</label> 
			<input type="text" name="memberMail1" id="memberMail" maxlength="15" class="in">@
			<input type="text" name="memberMail2" id="email_add" maxlength="15" class="in">
			<select name="email_sel" id="email_sel" onchange="change_email();">
				<option value="">직접입력</option>
				<option value="naver.com">naver</option>
				<option value="gmail.com">gmail</option>
				<option value="nate.com">nate</option>
			</select>
			<button type="submit" class="btn btn-primary" id="mailCheckBtn1">비밀번호 발송</button>
			<button type="button" th:onclick="|location.href='@{/login}'|">뒤로 가기</button>
	</div>
	</form>
<script>
var memberMail = document.getElementById("memberMail");	//이메일 앞
var email_add = document.getElementById("email_add");	//이메일 뒤


document.getElementById('mailCheckBtn1').addEventListener('click', (e)=>{ 
	e.preventDefault();
var email = memberMail.value + "@" + email_add.value;
// console.log(memberMail.value);
// console.log(email_add.value);
console.log(email);	
	if(memberMail.value==""||email_add.value==""){
		alert("메일 주소를 입력해주세요.");
		memberMail.focus
		return false;
	}
	checkId();
	});
   
	function change_email() {
		  var email_add = document.getElementById("email_add");
		  var email_sel = document.getElementById("email_sel");
	
		  //지금 골라진 옵션의 순서와 값 구하기
		  var idx = email_sel.options.selectedIndex;
		  var val = email_sel.options[idx].value;
	
		  email_add.value = val;
		}
	
	function checkId(){
        var email = memberMail.value + "@" + email_add.value; //id값이 "id"인 입력란의 값을 저장
       	console.log(email);
        $.ajax({
            url:"/joongbok", //Controller에서 요청 받을 주소
            type:'post', //POST 방식으로 전달
            data:{"email":email},
            success:function(cnt){ //컨트롤러에서 넘어온 cnt값을 받는다 
                if(cnt == 1){ //cnt가 1이면(=1일 경우) -> 존재하는 아이디 
                		alert("해당 이메일로 비밀번호 발송이 완료되었습니다. \n 확인부탁드립니다.")
	                	   $.ajax({
	                	   type : "POST",
	                	   url : "/emailFindPw",
	                	   data : {"email" : email},
	                	   success : function(data){
	                	      console.log("data : "+data)}
	                		})
                		$("#memberMail").attr("readonly",true);
                		$("#email_add").attr("readonly",true);
     					console.log(memberMail.value)
     					console.log(email);
     					location.href="http://localhost:8080/login";
                } else { // cnt가 0일 경우 -> 존재하지 않는 아이디
                     alert("가입되지 않은 이메일입니다. 이메일을 확인해주세요");
                    $('#memberMail').val('');
                }
            },
            error:function(){
                alert("에러입니다");
            }
        });
	};
</script>
	
</body>
</html>